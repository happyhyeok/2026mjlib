<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ë¬´ì‘ìœ„ìˆ˜ ìœ·ë†€ì´: ì˜¨ë¼ì¸ ë­í‚¹ì „</title>
    <style>
        :root { --yut-color: #8d6e63; --path-color: #d7ccc8; --highlight: #ff6b6b; --goal: #4caf50; --trap: #f06292; }
        body { font-family: 'Nanum Gothic', sans-serif; background-color: #e0f7fa; padding: 20px; margin: 0; }
        
        .main-container {
            display: flex;
            max-width: 1400px;
            margin: 0 auto;
            gap: 20px;
            align-items: flex-start;
            justify-content: center;
        }

        .left-panel { flex: 1; min-width: 280px; position: sticky; top: 20px; }
        
        .center-panel {
            flex: 1.5;
            min-width: 460px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255, 255, 255, 0.8);
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .right-panel {
            flex: 0.8;
            min-width: 250px;
            background: #fff;
            padding: 20px;
            border-radius: 20px;
            border: 3px solid #00acc1;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
        }

        .concept-box { background: #ffffff; border: 3px solid #00bcd4; padding: 25px; border-radius: 15px; text-align: left; }
        .concept-box h3 { color: #00838f; margin-top: 0; }
        .concept-box p { line-height: 1.6; color: #333; margin-bottom: 10px; }

        .goal-box { background: #333; color: gold; padding: 15px; border-radius: 10px; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        
        .yut-board { position: relative; width: 420px; height: 420px; margin: 10px auto; background: #fafafa; border: 8px solid #5d4037; border-radius: 20px; }
        .spot { position: absolute; width: 48px; height: 48px; background: var(--path-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; transition: 0.3s; }
        .spot.start { background: #3f51b5; color: white; }
        .spot.goal-spot { background: var(--goal); color: white; border: 4px solid gold; box-shadow: 0 0 10px gold; }
        .spot.trap-spot { background: var(--trap); color: white; font-size: 0.7rem; border: 2px solid #880e4f; white-space: pre-line; text-align: center; }

        #player { width: 38px; height: 38px; background: #ffeb3b; border: 4px solid #f57f17; border-radius: 50%; position: absolute; transition: all 0.3s ease; z-index: 10; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }
        
        .dashboard { display: flex; justify-content: center; gap: 15px; margin-bottom: 15px; width: 100%; }
        .counter { font-size: 1.1rem; background: white; padding: 8px 15px; border-radius: 20px; border: 2px solid #5d4037; flex: 1; text-align: center; }
        
        .controls { background: #efebe9; padding: 20px; border-radius: 15px; display: inline-block; border: 2px solid #5d4037; width: 100%; box-sizing: border-box; }
        input { width: 60px; padding: 8px; font-size: 1.1rem; border-radius: 5px; border: 1px solid #999; text-align: center; }
        button { padding: 10px 25px; font-size: 1.2rem; background: #5d4037; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }
        /* ì¬ë„ì „ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì¶”ê°€ */
        #retryBtn { background: #4caf50; margin-left: 10px; display: none; }
        #retryBtn:hover { background: #43a047; }
        
        .status { font-size: 1.3rem; font-weight: bold; margin: 15px; color: #d84315; min-height: 1.6em; text-align: center; }
        .remain { color: #2196f3; }

        /* ì˜¨ë¼ì¸ ë­í‚¹ ìŠ¤íƒ€ì¼ */
        .ranking-title { text-align: center; color: #00838f; border-bottom: 2px solid #00acc1; padding-bottom: 10px; margin-bottom: 15px; }
        .rank-list { list-style: none; padding: 0; margin: 0; max-height: 400px; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px dashed #ccc; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .rank-badge { background: #5d4037; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; justify-content: center; align-items: center; font-size: 0.8rem; margin-right: 8px; flex-shrink: 0; }
        .rank-item.top1 .rank-badge { background: gold; color: #333; box-shadow: 0 0 5px gold; }
        .rank-item.top2 .rank-badge { background: silver; color: #333; }
        .rank-item.top3 .rank-badge { background: #cd7f32; color: white; }
        .rank-score { font-weight: bold; color: #d84315; margin-left: auto; }
        .rank-name { margin-left: 5px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.95rem; max-width: 100px; }
        
        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 2s linear infinite; margin: 0 auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        @media (max-width: 1100px) {
            .main-container { flex-direction: column; align-items: center; }
            .left-panel, .center-panel, .right-panel { width: 90%; max-width: 600px; position: static; }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <!-- ì™¼ìª½: ì„¤ëª… -->
        <div class="left-panel">
            <div class="concept-box">
                <h3>ğŸŒ ì˜¨ë¼ì¸ ëŒ€ì „! ì „ëµ íƒí—˜ëŒ€</h3>
                <p>1ï¸âƒ£ <b>ì˜¨ë¼ì¸ ë­í‚¹:</b> ì´ì œ ë‚´ ê¸°ë¡ì´ ì„œë²„ì— ì €ì¥ë˜ì–´ ì „ ì„¸ê³„ ì¹œêµ¬ë“¤ê³¼ ê²½ìŸí•  ìˆ˜ ìˆì–´ìš”.</p>
                <p>2ï¸âƒ£ <b>ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸:</b> ë‹¤ë¥¸ ì¹œêµ¬ê°€ ê¸°ë¡ì„ ì„¸ìš°ë©´ ëª…ì˜ˆì˜ ì „ë‹¹ì´ ë°”ë¡œ ë°”ë€ë‹ˆë‹¤!</p>
                <p>3ï¸âƒ£ <b>ì „ëµ ìˆ˜ë¦½:</b> ìš¸íƒ€ë¦¬(ìµœì†Œ~ìµœëŒ€)ë¥¼ ì˜ ì¡°ì ˆí•´ì„œ ê°€ì¥ ì ì€ íšŸìˆ˜ë¡œ ë„ì°©í•´ ë³´ì„¸ìš”.</p>
            </div>
            <p style="text-align: center; color: #006064; font-size: 0.9rem; margin-top: 20px;">
                * 19ë²ˆ ì¹¸ì— ì •í™•íˆ ë©ˆì¶°ì•¼ ì„±ê³µì…ë‹ˆë‹¤!
            </p>
        </div>

        <!-- ê°€ìš´ë°: ê²Œì„ ë³´ë“œ -->
        <div class="center-panel">
            <div class="goal-box">
                <h2>ğŸ† ë¯¸ì…˜: ì •í™•íˆ 19ë²ˆ ì¹¸ì— ì°©ì§€í•˜ë¼!</h2>
                <p style="margin: 5px 0 0 0; font-size: 0.95rem;">ì§€ë‚˜ì¹˜ë©´ í•œ ë°”í€´ ë”! í•¨ì •ì€ <b>ì‹œë„ +2íšŒ</b> í˜ë„í‹°!</p>
            </div>

            <div class="dashboard">
                <div class="counter">ğŸ² ì‹œë„: <b id="tryCount">0</b>íšŒ</div>
                <div class="counter" id="distanceMsg">ë‚¨ì€ ì¹¸: <span class="remain">19ì¹¸</span></div>
            </div>

            <div class="yut-board" id="yutBoard"></div>

            <div class="controls">
                <b>ë²”ìœ„:</b> 
                <input type="number" id="min" placeholder="ìµœì†Œ" oninput="validate()"> ~ 
                <input type="number" id="max" placeholder="ìµœëŒ€" oninput="validate()">
                <button id="goBtn" onclick="moveYut()" disabled>ğŸ² ìˆ«ì ë½‘ê¸°!</button>
                <!-- ì¬ë„ì „ ë²„íŠ¼ ì¶”ê°€ -->
                <button id="retryBtn" onclick="resetGame()">ğŸ”„ ë‹¤ì‹œ ë„ì „</button>
            </div>

            <div id="statusMsg" class="status">ìˆ«ìë¥¼ ì…ë ¥í•´ ëª¨í—˜ì„ ì‹œì‘í•˜ì„¸ìš”!</div>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì˜¨ë¼ì¸ ìˆœìœ„ -->
        <div class="right-panel">
            <h3 class="ranking-title">ğŸŒ ê¸€ë¡œë²Œ ëª…ì˜ˆì˜ ì „ë‹¹ (Top 10)</h3>
            <div style="font-size: 0.8rem; color: #666; text-align: center; margin-bottom: 10px;">
                * ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ ë©ë‹ˆë‹¤.
            </div>
            <div id="rankingLoader" class="loader"></div>
            <ul id="rankList" class="rank-list">
                <li style="text-align:center; padding:10px; color:#999;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>
            </ul>
        </div>
    </div>

    <!-- Firebase SDK ë¡œë“œ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getDatabase, ref, push, onValue, query, orderByChild, limitToFirst } 
            from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

        // ì‚¬ìš©ì ì œê³µ Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyAUzYofAClqm5rHQjqo9HvsMRmix8oymis",
            authDomain: "randomgame-31630.firebaseapp.com",
            databaseURL: "https://randomgame-31630-default-rtdb.firebaseio.com",
            projectId: "randomgame-31630",
            storageBucket: "randomgame-31630.firebasestorage.app",
            messagingSenderId: "529691262815",
            appId: "1:529691262815:web:97388f5780e35a81ba00ea"
        };

        let db;
        let rankingsRef;

        try {
            const app = initializeApp(firebaseConfig);
            db = getDatabase(app);
            rankingsRef = ref(db, 'rankings');
            
            // ì‹¤ì‹œê°„ ë­í‚¹ ë¦¬ìŠ¤ë„ˆ ì‹œì‘
            startRankingListener();
        } catch (e) {
            console.error("Firebase ì´ˆê¸°í™” ì‹¤íŒ¨:", e);
            document.getElementById('rankList').innerHTML = 
                `<li style='text-align:center; color:red; padding:10px;'>
                    <b>ì„¤ì • ì˜¤ë¥˜!</b><br>
                    HTML íŒŒì¼ì„ ì—´ì–´<br>firebaseConfigë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.
                </li>`;
        }

        // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (module ë°–ì—ì„œ í˜¸ì¶œí•˜ê¸° ìœ„í•¨)
        window.registerOnlineRank = function(score) {
            if (!db) {
                alert("ë°ì´í„°ë² ì´ìŠ¤ê°€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
                // DBê°€ ì—†ì–´ë„ ì¬ë„ì „ì€ í•´ì•¼í•˜ë¯€ë¡œ ë²„íŠ¼ í‘œì‹œ
                window.showRetryButton();
                return;
            }
            
            const name = prompt("ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ëª…ì˜ˆì˜ ì „ë‹¹ì— ì´ë¦„ì„ ë‚¨ê¸°ì„¸ìš” (ì·¨ì†Œí•˜ë©´ ê¸°ë¡ë˜ì§€ ì•ŠìŒ):", "ëª¨í—˜ê°€");
            
            if (name) {
                // ë°ì´í„°ë² ì´ìŠ¤ì— ì €ì¥ (push)
                push(rankingsRef, {
                    name: name,
                    score: score,
                    timestamp: Date.now()
                }).then(() => {
                    alert("ê¸°ë¡ì´ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    window.showRetryButton(); // ì €ì¥ í›„ ì¬ë„ì „ ë²„íŠ¼ í‘œì‹œ
                }).catch((error) => {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + error.message);
                    window.showRetryButton(); // ì—ëŸ¬ ë‚˜ë„ ì¬ë„ì „ ë²„íŠ¼ í‘œì‹œ
                });
            } else {
                // ì·¨ì†Œí•œ ê²½ìš° ë°”ë¡œ ì¬ë„ì „ ë²„íŠ¼ í‘œì‹œ
                window.showRetryButton();
            }
        };

        function startRankingListener() {
            const list = document.getElementById("rankList");
            const loader = document.getElementById("rankingLoader");
            
            loader.style.display = "block";

            // ì ìˆ˜(score) ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ ì •ë ¬, ìƒìœ„ 10ê°œë§Œ ê°€ì ¸ì˜¤ê¸°
            const topRankQuery = query(rankingsRef, orderByChild('score'), limitToFirst(10));

            onValue(topRankQuery, (snapshot) => {
                loader.style.display = "none";
                list.innerHTML = "";
                
                if (!snapshot.exists()) {
                    list.innerHTML = "<li style='text-align:center; padding:10px; color:#999;'>ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ì£¼ì¸ê³µì´ ë˜ì–´ë³´ì„¸ìš”!</li>";
                    return;
                }

                const data = [];
                snapshot.forEach((childSnapshot) => {
                    data.push(childSnapshot.val());
                });

                // FirebaseëŠ” ì˜¤ë¦„ì°¨ìˆœìœ¼ë¡œ ì£¼ì§€ë§Œ, í™•ì‹¤í•˜ê²Œ ë°°ì—´ë¡œ ë°›ì•„ì„œ ë Œë”ë§
                data.forEach((rank, index) => {
                    const li = document.createElement("li");
                    li.className = `rank-item top${index+1}`;
                    
                    // ì´ë¦„ XSS ë°©ì§€ ì²˜ë¦¬
                    const safeName = rank.name ? rank.name.replace(/</g, "&lt;").replace(/>/g, "&gt;") : "ìµëª…";

                    li.innerHTML = `
                        <div style="display:flex; align-items:center; width: 100%;">
                            <span class="rank-badge">${index + 1}</span>
                            <span class="rank-name" title="${safeName}">${safeName}</span>
                            <span class="rank-score">${rank.score}íšŒ</span>
                        </div>
                    `;
                    list.appendChild(li);
                });
            });
        }
    </script>

    <!-- ê²Œì„ ë¡œì§ -->
    <script>
        const spots = [];
        const boardSize = 20; 
        const goalPos = 19;
        const traps = [4, 9, 14]; 
        const boardContainer = document.getElementById('yutBoard');
        let playerPos = 0;
        let tryCount = 0;
        let isGameOver = false;

        function createBoard() {
            for (let i = 0; i < boardSize; i++) {
                let x, y;
                if (i <= 5) { x = 350 - (i * 68); y = 350; } 
                else if (i <= 10) { x = 10; y = 350 - ((i-5) * 68); } 
                else if (i <= 15) { x = 10 + ((i-10) * 68); y = 10; } 
                else { x = 350; y = 10 + ((i-15) * 68); } 

                const spot = document.createElement('div');
                spot.className = 'spot';
                if (i === 0) { spot.classList.add('start'); spot.innerText = "ì¶œë°œ"; }
                else if (i === goalPos) { spot.classList.add('goal-spot'); spot.innerText = "ë„ì°©"; }
                else if (traps.includes(i)) { spot.classList.add('trap-spot'); spot.innerText = "í•¨ì •\n(+2)"; }
                else { spot.innerText = i; }
                
                spot.style.left = x + 'px';
                spot.style.top = y + 'px';
                boardContainer.appendChild(spot);
                spots.push({x: x + 5, y: y + 5});
            }
        }

        createBoard();

        const player = document.createElement('div');
        player.id = 'player';
        updatePlayerUI();
        boardContainer.appendChild(player);

        function validate() {
            if(isGameOver) return;
            const min = document.getElementById('min').value;
            const max = document.getElementById('max').value;
            const btn = document.getElementById('goBtn');
            btn.disabled = !(min !== "" && max !== "" && parseInt(max) >= parseInt(min));
        }

        function moveYut() {
            if(isGameOver) return;
            const min = parseInt(document.getElementById('min').value);
            const max = parseInt(document.getElementById('max').value);
            
            tryCount++;
            updateTryCount();

            const move = Math.floor(Math.random() * (max - min + 1)) + min;
            document.getElementById('statusMsg').innerText = `ğŸ² ${move}ì´(ê°€) ë‚˜ì™”ìŠµë‹ˆë‹¤!`;

            let currentMoveCount = 0;
            const moveInterval = setInterval(() => {
                playerPos++;
                currentMoveCount++;
                updatePlayerUI(playerPos % boardSize);

                if (currentMoveCount >= move) {
                    clearInterval(moveInterval);
                    checkLanding();
                }
            }, 150);
        }

        function checkLanding() {
            let finalPos = playerPos % boardSize;

            if (finalPos === goalPos) {
                // ì„±ê³µ ë¡œì§
                document.getElementById('statusMsg').innerHTML = "<span style='color:blue;'>ğŸŠ ì„±ê³µ!! ì •í™•íˆ ì•ˆì°©! ğŸŠ</span>";
                isGameOver = true;
                document.getElementById('goBtn').disabled = true;
                
                setTimeout(() => {
                    // ì˜¨ë¼ì¸ ë­í‚¹ ë“±ë¡ í•¨ìˆ˜ í˜¸ì¶œ
                    if (typeof window.registerOnlineRank === 'function') {
                        window.registerOnlineRank(tryCount);
                    } else {
                        alert(`ê²Œì„ ë! ì´ ì‹œë„: ${tryCount}íšŒ (DBì—°ë™ ì‹¤íŒ¨)`);
                        showRetryButton();
                    }
                }, 300);

            } else {
                if (playerPos > goalPos && finalPos <= goalPos) {
                    document.getElementById('statusMsg').innerText = "ì§€ë‚˜ì³¤ì–´ìš”! í•œ ë°”í€´ ë” ëŒì•„ì•¼ í•´ìš”.";
                } else if (traps.includes(finalPos)) {
                    tryCount += 2;
                    updateTryCount();
                    document.getElementById('statusMsg').innerText = "âš ï¸ í•¨ì • ë°œìƒ! ì‹œë„ íšŸìˆ˜ê°€ 2íšŒ ëŠ˜ì–´ë‚©ë‹ˆë‹¤!";
                } else {
                    document.getElementById('statusMsg').innerText = `${finalPos}ë²ˆ ì¹¸ì— ë©ˆì·„ìŠµë‹ˆë‹¤.`;
                }
                
                playerPos = finalPos;
                updateDistance();
            }
        }

        function updateTryCount() {
            document.getElementById('tryCount').innerText = tryCount;
        }

        function updateDistance() {
            let dist = goalPos - playerPos;
            if (dist < 0) dist += boardSize;
            document.getElementById('distanceMsg').innerHTML = `ë‚¨ì€ ì¹¸: <span class="remain">${dist}ì¹¸</span>`;
        }

        function updatePlayerUI(pos = playerPos) {
            player.style.left = spots[pos % boardSize].x + 'px';
            player.style.top = spots[pos % boardSize].y + 'px';
        }

        // --- ì¶”ê°€ëœ ì¬ë„ì „ ê´€ë ¨ í•¨ìˆ˜ë“¤ ---

        // ëª¨ë“ˆ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆë„ë¡ ì „ì—­ í•¨ìˆ˜ë¡œ ê³µê°œ
        window.showRetryButton = function() {
            document.getElementById('retryBtn').style.display = 'inline-block';
        }

        // ê²Œì„ ì´ˆê¸°í™” í•¨ìˆ˜
        function resetGame() {
            playerPos = 0;
            tryCount = 0;
            isGameOver = false;

            // UI ì´ˆê¸°í™”
            updatePlayerUI();
            updateTryCount();
            updateDistance();
            document.getElementById('statusMsg').innerText = "ìˆ«ìë¥¼ ì…ë ¥í•´ ëª¨í—˜ì„ ì‹œì‘í•˜ì„¸ìš”!";
            
            // ë²„íŠ¼ ìƒíƒœ ì œì–´
            document.getElementById('retryBtn').style.display = 'none';
            
            // ì…ë ¥ì°½ ì´ˆê¸°í™” ì›í•˜ì‹œë©´ ì•„ë˜ ì£¼ì„ í•´ì œí•˜ì„¸ìš” (í˜„ì¬ëŠ” ì „ëµ ìˆ˜ì •ì„ ìœ„í•´ ê°’ ìœ ì§€)
            // document.getElementById('min').value = '';
            // document.getElementById('max').value = '';

            // ê²Œì„ ì‹œì‘ ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
            validate();
        }
    </script>
</body>
</html>